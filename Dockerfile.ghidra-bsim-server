FROM alpine:latest AS build

ARG GHIDRA_HOME="/ghidra"
ENV GHIDRA_HOME=${GHIDRA_HOME}
ARG GHIDRA_INSTALL_DIR="/ghidra"
ENV GHIDRA_INSTALL_DIR=${GHIDRA_INSTALL_DIR}
ARG JAVA_HOME="/usr/lib/jvm/java-21-openjdk"
ENV JAVA_HOME=${JAVA_HOME}
ARG LD_LIBRARY_PATH="${JAVA_HOME}/lib/:/${JAVA_HOME}/lib/server/"
ENV LD_LIBRARY_PATH=${LD_LIBRARY_PATH}

ARG GHIDRA_VERSION=""
ENV GHIDRA_VERSION=${GHIDRA_VERSION}

ARG GHIDRA_OWNER="NationalSecurityAgency"
ENV GHIDRA_OWNER=${GHIDRA_OWNER}
ARG GHIDRA_REPO="ghidra"
ENV GHIDRA_REPO=${GHIDRA_REPO}
ENV GHIDRA_GITHUB_API="https://api.github.com/repos/${GHIDRA_OWNER}/${GHIDRA_REPO}"

ARG GHIDRA_USER="ghidra"
ENV GHIDRA_USER=${GHIDRA_USER}
ARG GHIDRA_GROUP="ghidra"
ENV GHIDRA_GROUP=${GHIDRA_GROUP}
ARG PUID="1001"
ENV PUID=${PUID}
ARG PGID="1001"
ENV PGID=${PGID}

RUN set -eux; \
    apk update; \
    apk add --no-cache \
        shadow \
        openjdk21 \
        bash \
        gcompat \
        unzip \
        curl \
        jq \
        python3 \
        py3-pip \
        python3-dev \
        perl \
    ; \
    addgroup -g ${PGID} -S ${GHIDRA_GROUP}; \
    adduser -u ${PUID} -S ${GHIDRA_USER} -G ${GHIDRA_GROUP}

RUN set -eux; \
    if [ -n "${GHIDRA_VERSION}" ]; then \
        API_URL="${GHIDRA_GITHUB_API}/releases/tags/Ghidra_${GHIDRA_VERSION}_build"; \
    else \
        API_URL="${GHIDRA_GITHUB_API}/releases/latest"; \
    fi; \
    BODY="$(curl -sSL -H 'Accept: application/vnd.github+json' "${API_URL}")"; \
    DOWNLOAD_URL="$(echo "${BODY}" | jq -r '.assets[] | select(.name | test("\\.zip$")) | select(.name | test("PUBLIC")) | .browser_download_url' | head -n 1)"; \
    if [ -z "${DOWNLOAD_URL}" ] || [ "${DOWNLOAD_URL}" = "null" ]; then \
        echo "Could not determine Ghidra download URL from ${API_URL}"; exit 1; \
    fi; \
    curl -sSL -o /tmp/ghidra.zip "${DOWNLOAD_URL}"; \
    unzip -q -d /tmp/ghidra_extract /tmp/ghidra.zip; \
    mv /tmp/ghidra_extract/ghidra_* ${GHIDRA_HOME}; \
    rm -f /tmp/ghidra.zip; \
    rm -rf /tmp/ghidra_extract

RUN set -eux; \
    apk add --no-cache --virtual .build-tools g++ gcc musl-dev make bison flex zlib-dev readline-dev perl python3-dev; \
    ${GHIDRA_HOME}/Ghidra/Features/BSim/support/make-postgres.sh; \
    apk del .build-tools; \
    mkdir -p ${GHIDRA_HOME}/bsim_datadir

COPY docker/start-ghidra-bsim-server.sh /ghidra/docker/start-ghidra-bsim-server.sh
RUN sed -i 's/\r$//' /ghidra/docker/start-ghidra-bsim-server.sh && chmod +x /ghidra/docker/start-ghidra-bsim-server.sh

FROM alpine:latest AS runtime

ARG JAVA_HOME="/usr/lib/jvm/java-21-openjdk"
ENV JAVA_HOME=${JAVA_HOME}
ARG LD_LIBRARY_PATH="${JAVA_HOME}/lib/:${JAVA_HOME}/lib/server/"
ENV LD_LIBRARY_PATH=${LD_LIBRARY_PATH}
ARG GHIDRA_HOME="/ghidra"
ENV GHIDRA_HOME=${GHIDRA_HOME}
ARG GHIDRA_INSTALL_DIR="/ghidra"
ENV GHIDRA_INSTALL_DIR=${GHIDRA_INSTALL_DIR}

ARG GHIDRA_USER="ghidra"
ENV GHIDRA_USER=${GHIDRA_USER}
ARG GHIDRA_GROUP="ghidra"
ENV GHIDRA_GROUP=${GHIDRA_GROUP}
ARG PUID="1001"
ENV PUID=${PUID}
ARG PGID="1001"
ENV PGID=${PGID}

RUN set -eux; \
    apk update; \
    apk add --no-cache \
        shadow \
        openjdk21 \
        bash \
        gcompat \
        libstdc++ \
    ; \
    addgroup -g ${PGID} -S ${GHIDRA_GROUP}; \
    adduser -u ${PUID} -S ${GHIDRA_USER} -G ${GHIDRA_GROUP}

WORKDIR ${GHIDRA_HOME}
COPY --from=build ${GHIDRA_HOME} ${GHIDRA_HOME}

RUN mkdir -p /work /projects \
    && chown -R ${GHIDRA_USER}:${GHIDRA_GROUP} ${GHIDRA_HOME} /work /projects

USER ${GHIDRA_USER}

ARG GHIDRA_BSIM_PORT="5432"
ENV GHIDRA_BSIM_PORT=${GHIDRA_BSIM_PORT}
EXPOSE ${GHIDRA_BSIM_PORT}

ENTRYPOINT ["/bin/bash", "/ghidra/docker/start-ghidra-bsim-server.sh"]
