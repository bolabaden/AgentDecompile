name: Test Ghidra ðŸ‰ Extension

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: write
  actions: read
  checks: write

jobs:
  test:
    strategy:
      matrix:
        os: [ubuntu-latest]
        ghidra-version: [
            "12.0",
            "latest",
        ]
    name: Build on Ghidra ${{ matrix.ghidra-version }}
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v6
      with:
        lfs: true

    - name: Set up Java ðŸµ
      uses: actions/setup-java@v5
      with:
        java-version: "21"
        distribution: "microsoft"

    - name: Install Ghidra ðŸ‰
      uses: antoniovazquezblanco/setup-ghidra@v2.0.16
      with:
        version: ${{ matrix.ghidra-version }}
        auth_token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Xvfb for headless testing
      run: |
        sudo apt-get update && sudo apt-get install -y xvfb
        Xvfb :99 -nolisten tcp &
        echo "DISPLAY=:99" >> $GITHUB_ENV


    - name: Setup Gradle ðŸ”§
      uses: gradle/actions/setup-gradle@v5
      with:
        gradle-version: "8.14"

    - name: Build Extension ðŸ”¨
      run: gradle buildExtension

    - name: Upload build artifacts
      uses: actions/upload-artifact@v6
      if: always()
      with:
        name: extension-build-${{ matrix.ghidra-version }}
        path: |
          dist/*.zip
          build/libs/
        if-no-files-found: ignore
