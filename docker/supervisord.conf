; AgentDecompile AIO: Ghidra server + BSim server + AgentDecompile MCP (headless).
; All output is prefixed by program name for readable interleaved logs.
; Start order: ghidra-server (1) -> bsim-server (2) -> agentdecompile-mcp (3).
; MCP waits for Ghidra server and BSim server to bind so it can connect to shared services.

[unix_http_server]
file=/tmp/supervisor.sock

[supervisord]
nodaemon=true
logfile=/dev/stdout
logfile_maxbytes=0
pidfile=/tmp/supervisord.pid
childlogdir=/tmp
loglevel=info
logfile_backups=0

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///tmp/supervisor.sock

; --- Program 1: Ghidra server (repository server). Start first so MCP can connect. ---
[program:ghidra-server]
command=/ghidra/docker/supervisor-wrap.sh ghidra-server /ghidra/server/ghidraSvr console
directory=/ghidra
autostart=true
autorestart=true
startsecs=2
priority=1
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
redirect_stderr=true

; --- Program 2: BSim server (embedded PostgreSQL from Ghidra BSim build). ---
[program:bsim-server]
command=/ghidra/docker/supervisor-wrap.sh bsim-server /ghidra/docker/supervisor-start-bsim.sh
directory=/ghidra
autostart=true
autorestart=true
startsecs=5
priority=2
startretries=3
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
redirect_stderr=true

; --- Program 3: AgentDecompile MCP (headless). Waits for Ghidra + BSim then starts. ---
; startsecs=15: module discovery + extension classpath + Application init may take ~10s.
[program:agentdecompile-mcp]
command=/ghidra/docker/supervisor-wrap.sh agentdecompile-mcp /ghidra/docker/supervisor-wait-then-mcp.sh
directory=/ghidra
autostart=true
autorestart=true
startsecs=15
priority=3
startretries=3
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
redirect_stderr=true
